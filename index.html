<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <style>
        /* Estilos generales del mapa y cuerpo */
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }

        /* Paneles de texto (Mantener para consistencia) */
        #texto {
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 9999;
            transition: all 0.5s ease-out;
            max-width: 400px;
            text-align: center;
        }

        /* Botón de cierre para el panel de texto */
        #cerrarTexto {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #777;
        }
        
        #cerrarTexto:hover {
            color: #333;
        }

        .hidden {
            opacity: 0;
            transform: translateY(20px);
        }
        .logo-container {
            margin-bottom: 0.5rem;
        }
        #logo {
            width: 60%;
            max-width: 80px;
            height: auto;
        }

        /* Estilos del popup - Más compactos */
        .popup-table {
            width: 100%;
            border-collapse: collapse;
            font-family: "Segoe UI", sans-serif;
            font-size: 12px;
            color: #333;
        }

        .popup-table th {
            text-align: left;
            font-weight: 600;
            padding: 4px 6px;
            background-color: #f0f4f8;
            color: #0078D7;
            border-bottom: 1px solid #ddd;
            width: 40%;
        }

        .popup-table td {
            padding: 4px 6px;
            border-bottom: 1px solid #eee;
            word-break: break-word;
        }

        /* Estilo para la simbología (control de capas) */
        .leaflet-control-layers.leaflet-control {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 8px 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            color: #333;
        }
        
        .leaflet-control-layers-overlays label {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .leaflet-control-layers-overlays label img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .leaflet-control-layers table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        
        .leaflet-control-layers table td {
            padding: 2px 0;
            font-size: 12px;
            vertical-align: middle;
            border: none;
        }
        
        .leaflet-control-layers table td img {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            vertical-align: middle;
        }

        .leaflet-control-layers-tree .leaflet-layerstree-header {
            font-weight: bold;
            color: #0056b3;
            margin-top: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #eee;
        }

        /* --- MEJORA DE VISUALIZACIÓN OP. 2A (BORDE DE ÍCONOS) --- */
        .leaflet-marker-icon {
            /* Añadir un borde blanco (2px) y una sombra sutil (1px) */
            box-shadow: 0 0 0 2px white, 0 0 0 3px rgba(0,0,0,0.3); 
            border-radius: 2px; 
        }

        /* Excluir el ícono de la leyenda para que no tenga el borde */
        .leaflet-control-layers img {
            box-shadow: none !important;
        }
        /* --- FIN MEJORA VISUALIZACIÓN --- */


        /* --- ESTILOS PARA LA VENTANA MODAL (DISCLAIMER) --- */
        #disclaimerModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(22, 42, 60, 0.6);
            z-index: 10000;
            display: block;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        #modalContent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            color: #2c3e50;
            padding: 4vmin;
            border-radius: 12px;
            max-width: 90%;
            width: 480px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            border-top: 5px solid #34495e;
        }

        #modalContent h2 {
            font-size: 2.5vmin;
            min-font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #34495e;
            font-weight: 700;
        }
        
        @media (max-width: 600px) {
            #modalContent h2 { font-size: 5vw; }
        }

        #modalContent p {
            font-size: 1.8vmin;
            min-font-size: 13px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #555;
        }
        
        @media (max-width: 600px) {
            #modalContent p { font-size: 3.5vw; }
        }

        #acceptDisclaimer {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
            text-transform: uppercase;
        }

        #acceptDisclaimer:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        /* --- FIN ESTILOS MODAL --- */

        /* Ajustes de posición para móvil y escritorio (texto y filtro) */
        @media (max-width: 767px) {
            #texto {
                position: fixed;
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto;
                margin: 0;
                display: none;
            }
            .leaflet-control-layers.leaflet-control {
                position: fixed;
                top: 10px;
                right: 10px;
                left: auto;
                bottom: auto;
            }
        }
        
        @media (min-width: 768px) {
            #texto {
                position: fixed;
                bottom: 10px;
                left: 10px;
                right: auto;
                width: 25%;
            }
        }
    </style>
    <title>Mapa de Proyectos Ejecutados</title>
</head>
<body>
    <div id="disclaimerModal">
        <div id="modalContent">
            <h2>⚠️ Aviso de Uso de Datos Referenciales</h2>
            <p>La información contenida en este mapa es de **carácter referencial y preliminar**. Los datos se presentan para fines ilustrativos y pueden no reflejar la situación oficial o más reciente.</p>
            <p><strong>Se requiere validación oficial para cualquier toma de decisión o uso legal de la información.</strong></p>
            <button id="acceptDisclaimer">Entendido y Aceptar</button>
        </div>
    </div>
    <div id="map">
        <div id="texto" style="display: none;">
            <button id="cerrarTexto">✕</button>
            <div class="logo-container">
                <a href="http://mapas.municoquimbo.cl/" target="_blank">
                    <img id="logo" src="images/logo.png" alt="Logo Municipalidad de Coquimbo">
                </a>
            </div>
            <strong>
                <br>
                <span style="font-size: 18px;">Proyectos Ejecutados 2021-2025</span><br>
                Ilustre Municipalidad de Coquimbo<br><br>
            </strong>
        </div>
    </div>
    
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet-svg-shape-markers.min.js"></script> 
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>
    
    <script>
        var json_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2;
        var json_SALUDYBIENESTAR_3;
        var json_ESPACIOSPUBLICOSYAREASVERDES_4;
        var json_INFRAESTRUCTURAURBANAYVIAL_5;
        var json_ADULTOMAYORYACCESIBILIDAD_6;
        var json_DESARROLLOPRODUCTIVOYTURISMO_7;
        var json_ENERGIAYELECTRICIDAD_8;
        var json_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9;
        var json_PROYECTOS2021_10;
        var json_PROYECTOS2022_11;
        var json_PROYECTOS2023_12;
        var json_PROYECTOS2024_13;
        var json_PROYECTOS2025_14;
        var json_ProyectosEjecutados20212025_15;
    </script>
    
    <script src="data/SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2.js"></script>
    <script src="data/SALUDYBIENESTAR_3.js"></script>
    <script src="data/ESPACIOSPUBLICOSYAREASVERDES_4.js"></script>
    <script src="data/INFRAESTRUCTURAURBANAYVIAL_5.js"></script>
    <script src="data/ADULTOMAYORYACCESIBILIDAD_6.js"></script>
    <script src="data/DESARROLLOPRODUCTIVOYTURISMO_7.js"></script>
    <script src="data/ENERGIAYELECTRICIDAD_8.js"></script>
    <script src="data/EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9.js"></script>
    <script src="data/PROYECTOS2021_10.js"></script>
    <script src="data/PROYECTOS2022_11.js"></script>
    <script src="data/PROYECTOS2023_12.js"></script>
    <script src="data/PROYECTOS2024_13.js"></script>
    <script src="data/PROYECTOS2025_14.js"></script>
    <script src="data/ProyectosEjecutados20212025_15.js"></script>
    
    <script>
        // Declaramos 'map' y 'autolinker' globalmente
        let map; 
        let autolinker;
        let bounds_group; 

        // Función para establecer los bounds del mapa
        function setBounds() {
            if (bounds_group && bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }

        // Funciones auxiliares para popups
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var th = rows[i].querySelector('th');
                var key = th ? th.innerText.trim() : ''; 
                
                if (key in feature.properties && (feature.properties[key] == null || feature.properties[key] === '')) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }
        
        function pop_Proyecto(feature, layer) {
            var p = feature.properties;
            var popupContent = '<table class="popup-table">\
            <tr><th scope="row">INICIATIVA</th><td>' + (p.INICIATIVA !== null ? autolinker.link(String(p.INICIATIVA)) : '') + '</td></tr>\
            <tr><th scope="row">FINANCIAMI</th><td>' + (p.FINANCIAMI !== null ? autolinker.link(String(p.FINANCIAMI)) : '') + '</td></tr>\
            <tr><th scope="row">EXTERNO</th><td>' + (p.EXTERNO !== null ? autolinker.link(String(p.EXTERNO)) : '') + '</td></tr>\
            <tr><th scope="row">MUNICIPAL</th><td>' + (p.MUNICIPAL !== null ? autolinker.link(String(p.MUNICIPAL)) : '') + '</td></tr>\
            <tr><th scope="row">MONTO</th><td>' + (p.MONTO !== null ? autolinker.link(String(p.MONTO)) : '') + '</td></tr>\
            <tr><th scope="row">ESTADO</th><td>' + (p.ESTADO !== null ? autolinker.link(String(p.ESTADO)) : '') + '</td></tr>\
            <tr><th scope="row">TEMATICA</th><td>' + (p.TEMATICA !== null ? autolinker.link(String(p.TEMATICA)) : '') + '</td></tr>\
            '+(p.AÑO !== undefined ? '<tr><th scope="row">AÑO</th><td>' + (p.AÑO !== null ? autolinker.link(String(p.AÑO)) : '') + '</td></tr>' : '')+'\
            </table>';
            
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.bindPopup(content, { maxHeight: 400 });
        }

        // Función para crear el círculo de la leyenda con tamaño y borde variables
        function createLegendSymbol(color, borderColor = 'rgba(35,35,35,1.0)', size = 12, borderWidth = 1.5) {
            const style = `
                width: ${size}px; 
                height: ${size}px; 
                margin-right: 5px; 
                display: inline-block; 
                vertical-align: middle; 
                border: ${borderWidth}px solid ${borderColor}; 
                border-radius: 50%; 
                background-color: ${color};
            `;
            return `<div style="${style}"></div>`;
        }

        // --- ESTILOS DE CAPAS (Temáticas - Iconos) ---
        function style_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/emergencia.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }
        function style_SALUDYBIENESTAR_3_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/salud.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }
        function style_ESPACIOSPUBLICOSYAREASVERDES_4_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/espacios publicos.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }
        function style_INFRAESTRUCTURAURBANAYVIAL_5_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/infraestructura.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }
        function style_ADULTOMAYORYACCESIBILIDAD_6_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/anciano.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }
        function style_DESARROLLOPRODUCTIVOYTURISMO_7_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/desarrollo.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }
        function style_ENERGIAYELECTRICIDAD_8_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/energia.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }
        function style_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9_0(feature, latlng) { return L.marker(latlng, { icon: L.icon({ iconUrl: 'images/equipamiento.png', iconSize: [24, 24], iconAnchor: [12, 24], popupAnchor: [0, -24] }) }); }

        // --- ESTILOS DE CAPAS (Años - Círculos) ---
        function style_PROYECTOS2021_10_0(feature) { return { pane: 'pane_PROYECTOS2021_10', radius: 4.0, opacity: 1, color: '#2980B9', weight: 1.5, fill: true, fillOpacity: 1, fillColor: '#3498DB', interactive: true }; }
        function style_PROYECTOS2022_11_0(feature) { return { pane: 'pane_PROYECTOS2022_11', radius: 5.0, opacity: 1, color: '#4A99C9', weight: 1.5, fill: true, fillOpacity: 1, fillColor: '#5DADE2', interactive: true }; }
        function style_PROYECTOS2023_12_0(feature) { return { pane: 'pane_PROYECTOS2023_12', radius: 6.0, opacity: 1, color: '#D6AA0E', weight: 1.5, fill: true, fillOpacity: 1, fillColor: '#F1C40F', interactive: true }; }
        function style_PROYECTOS2024_13_0(feature) { return { pane: 'pane_PROYECTOS2024_13', radius: 7.0, opacity: 1, color: '#CD691C', weight: 1.5, fill: true, fillOpacity: 1, fillColor: '#E67E22', interactive: true }; }
        function style_PROYECTOS2025_14_0(feature) { return { pane: 'pane_PROYECTOS2025_14', radius: 8.0, opacity: 1, color: '#C0392B', weight: 2.0, fill: true, fillOpacity: 1, fillColor: '#E74C3C', interactive: true }; }
        function style_ProyectosEjecutados20212025_15_0(feature) { return { pane: 'pane_ProyectosEjecutados20212025_15', radius: 7.0, opacity: 1, color: '#27AE60', weight: 1.5, fill: true, fillOpacity: 1, fillColor: '#2ECC71', interactive: true }; }

        // --- FUNCIÓN PRINCIPAL DE INICIALIZACIÓN ---
        function initializeMap() {
            // Inicialización del mapa
            map = L.map('map', {
                zoomControl: false, maxZoom: 28, minZoom: 1
            }).fitBounds([[-30.01648877193584, -71.37590360245304], [-29.92378802736024, -71.21192227222333]]);
            
            var hash = new L.Hash(map);
            map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
            autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });

            // Controles y featureGroup
            var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
            bounds_group = new L.featureGroup([]); 
            
            // Capas base (OpenStreetMap y Google Satelite)
            map.createPane('pane_GoogleSatelite_0');
            map.getPane('pane_GoogleSatelite_0').style.zIndex = 400;
            var layer_GoogleSatelite_0 = L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
                pane: 'pane_GoogleSatelite_0', opacity: 1.0, attribution: '', minZoom: 1, maxZoom: 28, minNativeZoom: 0, maxNativeZoom: 18
            });
            
            map.createPane('pane_OpenStreetMap_1');
            map.getPane('pane_OpenStreetMap_1').style.zIndex = 401;
            var layer_OpenStreetMap_1 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                pane: 'pane_OpenStreetMap_1', opacity: 1.0, attribution: '', minZoom: 1, maxZoom: 28, minNativeZoom: 0, maxNativeZoom: 19
            });
            map.addLayer(layer_OpenStreetMap_1);
            
            // --- INICIALIZACIÓN DE CAPAS GEOGRÁFICAS ---
            
            // Capas Temáticas (Iconos)
            var layer_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2 = new L.geoJson(json_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2, { pane: 'pane_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2', onEachFeature: pop_Proyecto, pointToLayer: style_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2_0 });
            map.createPane('pane_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2'); map.getPane('pane_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2').style.zIndex = 402; bounds_group.addLayer(layer_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2);

            var layer_SALUDYBIENESTAR_3 = new L.geoJson(json_SALUDYBIENESTAR_3, { pane: 'pane_SALUDYBIENESTAR_3', onEachFeature: pop_Proyecto, pointToLayer: style_SALUDYBIENESTAR_3_0 });
            map.createPane('pane_SALUDYBIENESTAR_3'); map.getPane('pane_SALUDYBIENESTAR_3').style.zIndex = 403; bounds_group.addLayer(layer_SALUDYBIENESTAR_3);

            var layer_ESPACIOSPUBLICOSYAREASVERDES_4 = new L.geoJson(json_ESPACIOSPUBLICOSYAREASVERDES_4, { pane: 'pane_ESPACIOSPUBLICOSYAREASVERDES_4', onEachFeature: pop_Proyecto, pointToLayer: style_ESPACIOSPUBLICOSYAREASVERDES_4_0 });
            map.createPane('pane_ESPACIOSPUBLICOSYAREASVERDES_4'); map.getPane('pane_ESPACIOSPUBLICOSYAREASVERDES_4').style.zIndex = 404; bounds_group.addLayer(layer_ESPACIOSPUBLICOSYAREASVERDES_4);

            var layer_INFRAESTRUCTURAURBANAYVIAL_5 = new L.geoJson(json_INFRAESTRUCTURAURBANAYVIAL_5, { pane: 'pane_INFRAESTRUCTURAURBANAYVIAL_5', onEachFeature: pop_Proyecto, pointToLayer: style_INFRAESTRUCTURAURBANAYVIAL_5_0 });
            map.createPane('pane_INFRAESTRUCTURAURBANAYVIAL_5'); map.getPane('pane_INFRAESTRUCTURAURBANAYVIAL_5').style.zIndex = 405; bounds_group.addLayer(layer_INFRAESTRUCTURAURBANAYVIAL_5);

            var layer_ADULTOMAYORYACCESIBILIDAD_6 = new L.geoJson(json_ADULTOMAYORYACCESIBILIDAD_6, { pane: 'pane_ADULTOMAYORYACCESIBILIDAD_6', onEachFeature: pop_Proyecto, pointToLayer: style_ADULTOMAYORYACCESIBILIDAD_6_0 });
            map.createPane('pane_ADULTOMAYORYACCESIBILIDAD_6'); map.getPane('pane_ADULTOMAYORYACCESIBILIDAD_6').style.zIndex = 406; bounds_group.addLayer(layer_ADULTOMAYORYACCESIBILIDAD_6);

            var layer_DESARROLLOPRODUCTIVOYTURISMO_7 = new L.geoJson(json_DESARROLLOPRODUCTIVOYTURISMO_7, { pane: 'pane_DESARROLLOPRODUCTIVOYTURISMO_7', onEachFeature: pop_Proyecto, pointToLayer: style_DESARROLLOPRODUCTIVOYTURISMO_7_0 });
            map.createPane('pane_DESARROLLOPRODUCTIVOYTURISMO_7'); map.getPane('pane_DESARROLLOPRODUCTIVOYTURISMO_7').style.zIndex = 407; bounds_group.addLayer(layer_DESARROLLOPRODUCTIVOYTURISMO_7);

            var layer_ENERGIAYELECTRICIDAD_8 = new L.geoJson(json_ENERGIAYELECTRICIDAD_8, { pane: 'pane_ENERGIAYELECTRICIDAD_8', onEachFeature: pop_Proyecto, pointToLayer: style_ENERGIAYELECTRICIDAD_8_0 });
            map.createPane('pane_ENERGIAYELECTRICIDAD_8'); map.getPane('pane_ENERGIAYELECTRICIDAD_8').style.zIndex = 408; bounds_group.addLayer(layer_ENERGIAYELECTRICIDAD_8);

            var layer_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9 = new L.geoJson(json_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9, { pane: 'pane_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9', onEachFeature: pop_Proyecto, pointToLayer: style_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9_0 });
            map.createPane('pane_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9'); map.getPane('pane_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9').style.zIndex = 409; bounds_group.addLayer(layer_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9);
            
            // Capas por Año (Círculos) 
            var layer_PROYECTOS2021_10 = new L.geoJson(json_PROYECTOS2021_10, { pane: 'pane_PROYECTOS2021_10', onEachFeature: pop_Proyecto, pointToLayer: function (feature, latlng) { return L.circleMarker(latlng, style_PROYECTOS2021_10_0(feature)); } });
            map.createPane('pane_PROYECTOS2021_10'); map.getPane('pane_PROYECTOS2021_10').style.zIndex = 410; bounds_group.addLayer(layer_PROYECTOS2021_10); map.addLayer(layer_PROYECTOS2021_10);

            var layer_PROYECTOS2022_11 = new L.geoJson(json_PROYECTOS2022_11, { pane: 'pane_PROYECTOS2022_11', onEachFeature: pop_Proyecto, pointToLayer: function (feature, latlng) { return L.circleMarker(latlng, style_PROYECTOS2022_11_0(feature)); } });
            map.createPane('pane_PROYECTOS2022_11'); map.getPane('pane_PROYECTOS2022_11').style.zIndex = 411; bounds_group.addLayer(layer_PROYECTOS2022_11); map.addLayer(layer_PROYECTOS2022_11);

            var layer_PROYECTOS2023_12 = new L.geoJson(json_PROYECTOS2023_12, { pane: 'pane_PROYECTOS2023_12', onEachFeature: pop_Proyecto, pointToLayer: function (feature, latlng) { return L.circleMarker(latlng, style_PROYECTOS2023_12_0(feature)); } });
            map.createPane('pane_PROYECTOS2023_12'); map.getPane('pane_PROYECTOS2023_12').style.zIndex = 412; bounds_group.addLayer(layer_PROYECTOS2023_12); map.addLayer(layer_PROYECTOS2023_12);

            var layer_PROYECTOS2024_13 = new L.geoJson(json_PROYECTOS2024_13, { pane: 'pane_PROYECTOS2024_13', onEachFeature: pop_Proyecto, pointToLayer: function (feature, latlng) { return L.circleMarker(latlng, style_PROYECTOS2024_13_0(feature)); } });
            map.createPane('pane_PROYECTOS2024_13'); map.getPane('pane_PROYECTOS2024_13').style.zIndex = 413; bounds_group.addLayer(layer_PROYECTOS2024_13); map.addLayer(layer_PROYECTOS2024_13);

            var layer_PROYECTOS2025_14 = new L.geoJson(json_PROYECTOS2025_14, { pane: 'pane_PROYECTOS2025_14', onEachFeature: pop_Proyecto, pointToLayer: function (feature, latlng) { return L.circleMarker(latlng, style_PROYECTOS2025_14_0(feature)); } });
            map.createPane('pane_PROYECTOS2025_14'); map.getPane('pane_PROYECTOS2025_14').style.zIndex = 414; bounds_group.addLayer(layer_PROYECTOS2025_14); map.addLayer(layer_PROYECTOS2025_14);

            // Capa Proyectos Ejecutados (Inicialmente activada)
            var layer_ProyectosEjecutados20212025_15 = new L.geoJson(json_ProyectosEjecutados20212025_15, { pane: 'pane_ProyectosEjecutados20212025_15', onEachFeature: pop_Proyecto, pointToLayer: function (feature, latlng) { return L.circleMarker(latlng, style_ProyectosEjecutados20212025_15_0(feature)); } });
            map.createPane('pane_ProyectosEjecutados20212025_15'); map.getPane('pane_ProyectosEjecutados20212025_15').style.zIndex = 415; bounds_group.addLayer(layer_ProyectosEjecutados20212025_15);
            map.addLayer(layer_ProyectosEjecutados20212025_15);


            // Control de capas (simbología)
            var overlaysTree = [
                {
                    label: createLegendSymbol('#2ECC71', '#27AE60', 14, 1.5) + '<span style="font-weight:bold;">Proyectos Ejecutados 2021-2025</span>',
                    layer: layer_ProyectosEjecutados20212025_15,
                    checked: true
                },
                {
                    label: '<b>Proyectos por Año (Gradiente Temporal)</b>',
                    selectAllCheckbox: true,
                    children: [
                        { label: createLegendSymbol('#E74C3C', '#C0392B', 16, 2.0) + 'PROYECTOS 2025 🔴', layer: layer_PROYECTOS2025_14, checked: true },
                        { label: createLegendSymbol('#E67E22', '#CD691C', 14) + 'PROYECTOS 2024 🟠', layer: layer_PROYECTOS2024_13, checked: true },
                        { label: createLegendSymbol('#F1C40F', '#D6AA0E', 12) + 'PROYECTOS 2023 🟡', layer: layer_PROYECTOS2023_12, checked: true },
                        { label: createLegendSymbol('#5DADE2', '#4A99C9', 10) + 'PROYECTOS 2022 🔵', layer: layer_PROYECTOS2022_11, checked: true },
                        { label: createLegendSymbol('#3498DB', '#2980B9', 8) + 'PROYECTOS 2021 🔹', layer: layer_PROYECTOS2021_10, checked: true },
                    ]
                },
                {
                    label: '<b>Proyectos por Temática (Íconos)</b>',
                    selectAllCheckbox: true,
                    children: [
                        { label: '<img src="images/equipamiento.png" /> EQUIPAMIENTO COMUNITARIO Y EDIFICIOS PUBLICOS', layer: layer_EQUIPAMIENTOCOMUNITARIOYEDIFICIOSPUBLICOS_9, checked: false },
                        { label: '<img src="images/energia.png" /> ENERGIA Y ELECTRICIDAD', layer: layer_ENERGIAYELECTRICIDAD_8, checked: false },
                        { label: '<img src="images/desarrollo.png" /> DESARROLLO PRODUCTIVO Y TURISMO', layer: layer_DESARROLLOPRODUCTIVOYTURISMO_7, checked: false },
                        { label: '<img src="images/anciano.png" /> ADULTO MAYOR Y ACCESIBILIDAD', layer: layer_ADULTOMAYORYACCESIBILIDAD_6, checked: false },
                        { label: '<img src="images/infraestructura.png" /> INFRAESTRUCTURA URBANA Y VIAL', layer: layer_INFRAESTRUCTURAURBANAYVIAL_5, checked: false },
                        { label: '<img src="images/espacios publicos.png" /> ESPACIOS PUBLICOS Y AREAS VERDES', layer: layer_ESPACIOSPUBLICOSYAREASVERDES_4, checked: false },
                        { label: '<img src="images/salud.png" /> SALUD Y BIENESTAR', layer: layer_SALUDYBIENESTAR_3, checked: false },
                        { label: '<img src="images/emergencia.png" /> SEGURIDAD, EMERGENCIA Y SERVICIOS PUBLICOS', layer: layer_SEGURIDADEMERGENCIAYSERVICIOSPUBLICOS_2, checked: false },
                    ]
                },
                { label: "Google Satelite", layer: layer_GoogleSatelite_0, checked: false },
                { label: "OpenStreetMap", layer: layer_OpenStreetMap_1, checked: true },
            ];
            var lay = L.control.layers.tree(null, overlaysTree,{ collapsed: true, }).addTo(map);

            // Muestra el panel de texto después de la inicialización (si es escritorio)
            if (window.innerWidth >= 768) {
                document.getElementById('texto').style.display = 'block';
            }

            // Aseguramos que el mapa se redibuje correctamente
            map.invalidateSize();

            // Configura los bounds iniciales
            setBounds();
        }

        // Esta lógica se ejecuta al cargar la página
        document.addEventListener("DOMContentLoaded", function() {
            const disclaimerModal = document.getElementById('disclaimerModal');
            const acceptDisclaimerBtn = document.getElementById('acceptDisclaimer');
            
            // 1. Muestra el Modal de Aviso al inicio
            disclaimerModal.style.display = 'block';
            setTimeout(() => { disclaimerModal.style.opacity = 1; }, 10);
            
            // 2. Al hacer clic en Aceptar
            acceptDisclaimerBtn.addEventListener('click', function() {
                disclaimerModal.style.opacity = 0;
                setTimeout(() => {
                    disclaimerModal.style.display = 'none';
                    // 3. Inicializa el mapa SOLO después de aceptar
                    initializeMap();
                }, 500);
            });

            // Lógica para el panel de texto
            const cerrarTextoBtn = document.getElementById('cerrarTexto');
            const textoPanel = document.getElementById('texto');
            if (cerrarTextoBtn && textoPanel) {
                cerrarTextoBtn.addEventListener('click', () => {
                    textoPanel.classList.add('hidden');
                    setTimeout(() => { textoPanel.style.display = 'none'; }, 500);
                });
            }
        });
    </script>
</body>
</html>
